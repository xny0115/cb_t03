# AI 병합(머지) 충돌 방지 규칙 v2  #AI_MERGE_RULES
_2025-09-17_

본 규칙은 모든 프로젝트에 **변경 없이 공용 적용**합니다.  
코덱스(Codex) 및 모든 AI 에이전트가 자동 커밋·PR을 수행할 때 반드시 준수합니다.

---

## 1) 작업 범위
- **실제 코드에 존재하는 파일·경로만** 수정 대상에 포함합니다.
- 보존본(백업본) 디렉터리는 **읽기 전용**으로 취급하며, 수정·삭제·이동을 금지합니다.  
  예) `_bak_*/`, `backup/`, `archive/` 등
- `.gitignore`에 포함된 산출물(모델 가중치, 토크나이저, 임시/캐시 데이터 등)은 **추적·커밋 금지**입니다.

## 2) 브랜치 운용
- 기본 브랜치: **main**
- AI 작업 브랜치명: **codex/feature/YYYYMMDD-<short>**  (ASCII만 사용)
- PR 병합 정책: **Squash Merge만 허용**. _Direct merge / fast-forward 금지._
- 기본 타깃 브랜치는 `main`입니다(프로젝트에서 별도 지정 시 해당 규칙을 따릅니다).

## 3) 충돌 자동 해결 정책(공용)
**목표:** 작업 브랜치를 대상 브랜치와 병합할 때, 충돌을 **규칙 기반으로 자동 해결**하여 “Merge 가능” 상태로 만듭니다.

- **기본 우선권(Default):** `OURS` (작업 브랜치 우선)  
  _프로젝트별로 `THEIRS`로 바꿀 수 있으나, 변경 시 문서에 명시해야 합니다._
- **예외(상대 유지 / KEEP_THEIRS_PATTERNS):** `Changelog.md`, `WORKLOG.md`  
  _로그/이력 파일은 대상 브랜치 쪽(theirs) 버전을 채택합니다._
- **예외(내 쪽 유지 / KEEP_OURS_PATTERNS):** _(기본 없음)_  
  _프로젝트별 필요 시 추가합니다(예: 핵심 설정 디렉터리 등)._
- **제외(EXCLUDE):** `_bak_*`, `backup/`, `archive/` 등 보존본 경로 및 추적 금지 산출물.
- **불가 조건:** 위 규칙을 적용해도 남는 충돌이 1건이라도 있으면 **즉시 중단**하고 보고합니다(임의 수정 금지).

## 4) 표준 절차(예방·병합)
1. **동기화:** `fetch --all --prune`로 원격 갱신. 새 작업 브랜치 생성/전환.
2. **선반영:** `origin/main` 변경을 **작업 브랜치에 병합**하여 최신 코드를 반영합니다.  
   _(rebase 사용 가능. 단, 최종 PR은 squash로 병합합니다.)_
3. **검증:** 테스트·빌드·기본 실행 확인 후 PR 생성.
4. **리뷰 반영:** 필요 시 2–3단계를 반복.
5. **병합 시도:** 충돌 발생 시 **3번의 자동 해결 정책**을 적용. 남은 충돌이 있으면 **즉시 중단**.
6. **완료:** 충돌 0건이면 커밋 후 푸시 → PR이 “Merge 가능” 상태여야 합니다.

## 5) 파일 잠금 규칙
- 핵심 진입점/메인 서비스/모델 정의 등은 **단독 변경 원칙**을 적용합니다.
- 위 파일을 수정하는 PR은 **동일 시점 1개만 허용**(병렬 PR 금지).  
- 각 프로젝트는 잠금 대상 목록을 **MERGE_LOCK_FILES**로 문서화합니다.

## 6) 자동 생성 산출물·형식 PR 금지
- 학습 산출물, 모델 가중치, 토크나이저, 임시/캐시 데이터 등은 **커밋 금지**입니다.
- 포맷팅 전용 PR(예: 대량 리포맷만 포함)은 금지합니다. 실제 변경과 함께 최소화된 범위로 포함합니다.

## 7) PR 체크리스트(코덱스/AI 필수)
- 테스트·빌드 통과(예: `pytest`, `build`).
- 필수 의존성 설치 후 **실행 가능** 확인.
- 변경된 파일명·함수명·경로명은 **실제 코드에 존재하는 값만** 사용(임의 네이밍 금지).
- 병합 전 **충돌 여부 확인** 및 **자동 해결 정책 적용 결과** 검증.
- 아래 **자동 병합 보고서**를 PR 설명에 포함.

## 8) 자동 병합 보고서(완료/중단 시 단일 보고)
- 대상/작업 브랜치명, 적용 기본 우선권(OURS|THEIRS)
- 충돌 처리 결과 요약  
  - KEEP_THEIRS 적용 파일 목록(예: `Changelog.md`, `WORKLOG.md`)  
  - KEEP_OURS 적용 파일 목록  
  - 기본 정책으로 처리된 파일 수
- 남은 충돌 유무(있으면 파일명·대략적 위치) 및 **중단 사유**
- 최종 PR 상태: **Merge 가능/불가**
- 제외/스킵된 파일(보존본·산출물 등)과 사유

## 9) 실패 처리·제한(엄수)
- 규칙으로 해결 불가 시 **즉시 중단**, 1회 보고 후 대기(임의 재시도 금지).
- **구조·시그니처 변경, 대량 리팩토링, 대량 포맷팅 금지.**
- 지정 예외 패턴 외에 상대 브랜치 내용으로 **덮어쓰기 금지.**

## 10) 개정 이력
- **v2 (2025-09-17):**  
  - 충돌 자동 해결 정책(기본 OURS + 로그 파일 THEIRS) 명시.  
  - “Squash only / FF 금지”로 병합 정책 정비.  
  - 선반영 단계에서 불필요한 `--no-ff` 표기를 삭제하고 절차 명확화.  
  - 자동 병합 보고서 양식 추가, 실패 처리 기준 강화.

---

**요약:** 기본은 `OURS`, 로그 파일은 `THEIRS`. 보존본·산출물은 제외. Squash만 허용.  
충돌이 남으면 **즉시 중단 후 보고** — 임의 수정·재시도 금지.
